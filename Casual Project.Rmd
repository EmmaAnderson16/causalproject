---
title: "Causal Project"
author: "Emma Anderson"
date: "2024-04-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(lubridate)
library(knitr)
library(ggplot2)
#library(plyr) # for count function
library(kableExtra)
library(tidyr)
library(dplyr)
library(tidyverse)
library(haven)
library(tableone)
#setwd("~/Documents/Github/causalproject")
```


```{r reading in and cleaning}
#exposure   
benzene <- read_xpt("P_UVOC2.XPT")
#limit of detection 9.81 
colnames(benzene)
benzene<-benzene[,-c(2,4:6)]
#outcome
repro <- read_xpt("P_RHQ.XPT")
repro$diabetes_binary <- ifelse(repro$RHQ162 == 2, 0, 1)
repro <- repro[,-c(2:17, 19:32)] 
#covariates
smoking <- read_xpt("P_SMQ.XPT")
smoking$smoke_binary <- ifelse(smoking$SMQ020 == 2, 0, 1)
smoking <- smoking[,-c(2:16)]
demographic <- read_xpt("P_DEMO.XPT")
colnames(demographic)
demographic <- demographic %>% filter(RIAGENDR==2)
demographic <- demographic[,-c(2:4,6:7,9:11,13:28)]
care <- read_xpt("P_HUQ.XPT")
care$care_binary <- ifelse(care$HUQ030 == 2, 1, 0)
care <- care[,-c(2:7)]
```

```{r}
#merge 
merged_data <- merge(benzene, repro, by = "SEQN")
merged_data <- merge(merged_data, smoking, by = "SEQN")
merged_data <- merge(merged_data, demographic, by = "SEQN")
merged_data <- merge(merged_data, care, by = "SEQN")

colnames(merged_data)

merged_data <- merged_data %>%
  rename(benzene = URXMUCA,
         diabetes = diabetes_binary, 
         baby_weight = RHQ172, 
         smoking = smoke_binary, 
         age = RIDAGEYR, 
         race = RIDRETH3, 
         education = DMDEDUC2, 
         income = INDFMPIR,
         access_care = care_binary
         )

merged_data <- merged_data[!is.na(merged_data$benzene) & !is.na(merged_data$diabetes), ]

#make benzene binary with median 48.15
summary(merged_data$benzene)

merged_data <- merged_data %>% 
  mutate(
    benzene_binary = ifelse(benzene <= 48.15, "Low", "High")
  )

table(merged_data$diabetes, merged_data$benzene_binary)


```

```{r}
merged_data <- merged_data %>% 
    mutate(race_category = case_when(
        race %in% c(1,2) ~ "Hispanic",
        race == 3 ~ "Non-Hispanic White",
        race == 4 ~ "Non-Hispanic Black",
        race == 6 ~ "Non-Hispanic Asian",
        race == 7 ~ "Other"
    ))

merged_data <- merged_data %>% 
    mutate(education_category = case_when(
        education %in% c(1,2) ~ "Less than high school",
        education == 3 ~ "High school diploma",
        education == 4 ~ "Some college",
        education == 5 ~ "College graduate or above"
    ))
```

```{r}
final_data <- merged_data[,c(1:6,9:13)]

final_data2 <- final_data[complete.cases(final_data), ]

```

```{r table1}
table.1.vars <- c("benzene_binary", "diabetes", "smoking", "age", "race_category", "education_category", "income", "access_care")
    
table.1.fvars <- c("race_category", "education_category", "diabetes", "smoking", "access_care")
    
table.1 <- CreateTableOne(vars = table.1.vars, 
                          strata = "benzene_binary",
                          factorVars = table.1.fvars,
                          data = final_data, includeNA=FALSE,
                          test=FALSE, addOverall=TRUE)
print(table.1)
```
G-comp
```{r}
final_data2 <- final_data2 %>% 
  mutate(
    benzene_numerical = ifelse(benzene_binary == "Low", 0, 1)
  )


reg.model <- glm(diabetes ~ benzene_numerical + smoking + age + income + access_care + race_category + education_category, family='binomial', data=final_data2)
summary(reg.model)
```

```{r}
exposed <- unexposed <- final_data2

exposed$benzene_numerical <- 1
unexposed$benzene_numerical <- 0

predictY.exposed<- predict(reg.model, newdata = exposed, type='response')
predictY.unexposed<- predict(reg.model, newdata = unexposed, type='response')

mean(predictY.exposed - predictY.unexposed)
```

Unadjusted estimator
```{r}
unadjusted <- mean(final_data2$benzene_numerical == 1) - mean(final_data2$benzene_numerical == 0)

unadjusted

```


```{r, IPW}
##### Inverse probability weighting
final_data <- final_data %>% 
  mutate(
    benzene_numerical = ifelse(benzene_binary == "Low", 0, 1)
  )
model.reg <- glm(benzene_numerical ~ smoking + age + income + access_care + race_category, family=binomial, 
               data=final_data) 
summary(model.reg)
#Estimate predicted probabilities of observed:
prob.1W <- predict(model.reg, type="response") # Predicted probability of observed
prob.0W <- 1-prob.1W # Predicted probability of not having diabetes 

summary(prob.1W)
summary(prob.0W)

#weights
wt1 <- as.numeric(final_data$benzene_numerical==1)/prob.1W
wt0 <- as.numeric(final_data$benzene_numerical==0)/prob.0W
summary(wt1)
summary(wt0)
#point estimates 
IPW<- mean(wt1*final_data$diabetes) - mean( wt0*final_data$diabetes)
IPW
mean( (wt1-wt0)*final_data$diabetes)
#Stabilized IPW estimator - Modified Horvitz-Thompson estimator
mean(wt1*final_data$diabetes)/mean( wt1) - mean( wt0*final_data$diabetes)/mean( wt0)
```

